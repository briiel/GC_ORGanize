<div class="p-3 sm:p-6 bg-gray-100 min-h-screen">
  <!-- Header -->
  <div class="mb-6 mx-0 sm:mx-2 lg:mx-6">
    <div class="bg-white rounded-lg shadow-md p-4 sm:p-5 border-l-4 border-[#679436]">
      <div class="flex items-center justify-between gap-3">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-lg bg-[#679436] flex items-center justify-center">
            <i class="fas fa-certificate text-white"></i>
          </div>
          <div>
            <h1 class="text-xl font-bold text-gray-800">E-Certificate Requests</h1>
            <p class="text-sm text-gray-600">Review and approve student certificate requests</p>
          </div>
        </div>
        <div class="hidden sm:flex items-center gap-2 bg-[#679436] text-white px-4 py-2 rounded-lg">
          <i class="fas fa-hourglass-half text-lg"></i>
          <div class="text-left">
            <p class="text-xs opacity-80">Pending</p>
            <p class="text-xl font-bold">{{ getPendingCount() }}</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Stats Cards - Mobile -->
  <div class="sm:hidden mb-6 mx-2 lg:mx-6">
    <div class="bg-white rounded-lg shadow-md border border-gray-200 p-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="w-12 h-12 rounded-lg bg-yellow-100 flex items-center justify-center">
            <i class="fas fa-hourglass-half text-yellow-600 text-xl"></i>
          </div>
          <div>
            <p class="text-sm font-medium text-gray-600">Pending Requests</p>
            <p class="text-2xl font-bold text-yellow-600">{{ getPendingCount() }}</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Filters -->
  <div class="mb-6 mx-2 lg:mx-6">
    <div class="bg-white rounded-lg shadow-md border border-gray-200 overflow-hidden">
      <div class="p-5">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <!-- Search -->
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">
              <i class="fas fa-search mr-1 text-gray-500"></i>
              Search
            </label>
            <input 
              type="text" 
              [(ngModel)]="searchTerm" 
              (input)="onFilterChange()"
              placeholder="Search by event, student name, ID, or email..."
              class="w-full px-4 py-2.5 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-[#679436] focus:border-[#679436] transition-all">
          </div>

          <!-- Status Filter -->
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">
              <i class="fas fa-tasks mr-1 text-gray-500"></i>
              Status
            </label>
            <select 
              [(ngModel)]="statusFilter" 
              (change)="onFilterChange()"
              class="w-full px-4 py-2.5 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-[#679436] focus:border-[#679436] transition-all font-medium text-gray-700">
              <option value="all">All Requests</option>
              <option value="pending">Pending</option>
              <option value="processing">Processing</option>
              <option value="sent">Sent</option>
            </select>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast / Messages -->
  <div class="mx-2 lg:mx-6">
    <div *ngIf="successMessage" class="mb-4">
      <div class="toast success">
        <div class="toast-body">
          <i class="fas fa-check-circle"></i>
          <span class="toast-text">{{ successMessage }}</span>
        </div>
        <button class="toast-close" (click)="successMessage = null">×</button>
      </div>
    </div>
    <div *ngIf="error" class="mb-4">
      <div class="toast error">
        <div class="toast-body">
          <i class="fas fa-exclamation-triangle"></i>
          <span class="toast-text">{{ error }}</span>
        </div>
        <button class="toast-close" (click)="error = null">×</button>
      </div>
    </div>
  </div>

  <!-- Bulk Actions Bar -->
  <div *ngIf="!loading && !error && filteredRequests.length > 0" class="mb-6 mx-2 lg:mx-6">
    <div class="bg-gradient-to-r from-[#679436] to-[#567a2d] rounded-lg shadow-md border-2 border-[#679436] overflow-hidden">
      <div class="p-4">
        <div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-4">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-lg bg-white/20 flex items-center justify-center border-2 border-white/30">
              <i class="fas fa-tasks text-white text-lg"></i>
            </div>
            <div>
              <h3 class="text-white font-bold text-sm">Bulk Actions</h3>
              <p class="text-white/80 text-xs">
                <span *ngIf="selectedRequests.size === 0">Select requests to update their status</span>
                <span *ngIf="selectedRequests.size > 0">{{ selectedRequests.size }} request(s) selected</span>
              </p>
            </div>
          </div>
          
          <div class="flex items-center gap-3 w-full md:w-auto">
            <select 
              [(ngModel)]="bulkStatus"
              [disabled]="selectedRequests.size === 0 || isUpdatingBulk"
              class="px-4 py-2 border-2 border-white/30 bg-white/10 text-white rounded-lg focus:ring-2 focus:ring-white focus:border-white transition-all font-semibold text-sm disabled:opacity-50 disabled:cursor-not-allowed backdrop-blur-sm">
              <option value="pending" class="bg-gray-800 text-white">PENDING</option>
              <option value="processing" class="bg-gray-800 text-white">PROCESSING</option>
              <option value="sent" class="bg-gray-800 text-white">SENT</option>
            </select>
            
            <button
              (click)="bulkUpdateStatus()"
              [disabled]="selectedRequests.size === 0 || isUpdatingBulk"
              class="px-4 py-2 bg-white text-[#679436] rounded-lg font-bold text-sm hover:bg-gray-100 transition-all disabled:opacity-50 disabled:cursor-not-allowed shadow-lg flex items-center gap-2">
              <i *ngIf="!isUpdatingBulk" class="fas fa-sync-alt"></i>
              <i *ngIf="isUpdatingBulk" class="fas fa-spinner fa-spin"></i>
              <span *ngIf="!isUpdatingBulk">Update Selected</span>
              <span *ngIf="isUpdatingBulk">Updating...</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="loading" class="mx-2 lg:mx-6">
    <div class="bg-white rounded-lg shadow-md border border-gray-200 p-12 text-center">
      <div class="inline-block animate-spin rounded-full h-16 w-16 border-4 border-gray-200 border-t-[#679436]"></div>
      <p class="mt-4 text-gray-600 font-medium">Loading certificate requests...</p>
    </div>
  </div>

  <!-- Error State -->
  <div *ngIf="error && !loading" class="mx-2 lg:mx-6 mb-6">
    <div class="bg-red-50 border-l-4 border-red-500 rounded-lg p-5 shadow-md">
      <div class="flex items-start">
        <div class="w-10 h-10 rounded-lg bg-red-100 flex items-center justify-center flex-shrink-0">
          <i class="fas fa-exclamation-circle text-red-600 text-lg"></i>
        </div>
        <div class="ml-4">
          <h3 class="text-sm font-bold text-red-800 mb-1">Error Loading Requests</h3>
          <p class="text-sm text-red-700">{{ error }}</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Requests List -->
  <div *ngIf="!loading && !error" class="mx-2 lg:mx-6">
    <!-- Empty State -->
    <div *ngIf="filteredRequests.length === 0" class="bg-white rounded-lg shadow-md border border-gray-200 p-12 text-center">
      <div class="w-20 h-20 mx-auto mb-4 rounded-full bg-gray-100 flex items-center justify-center">
        <i class="fas fa-inbox text-gray-400 text-4xl"></i>
      </div>
      <h3 class="text-xl font-bold text-gray-900 mb-2">No Certificate Requests Found</h3>
      <p class="text-gray-600 mb-4">
        <span *ngIf="statusFilter !== 'all' || searchTerm">Try adjusting your filters to see more results</span>
        <span *ngIf="statusFilter === 'all' && !searchTerm">Certificate requests from students will appear here</span>
      </p>
      <button 
        *ngIf="statusFilter !== 'all' || searchTerm"
        (click)="statusFilter = 'all'; searchTerm = ''; onFilterChange()"
        class="px-4 py-2 bg-[#679436] text-white rounded-lg hover:bg-[#56732e] transition-colors font-semibold">
        <i class="fas fa-redo mr-2"></i>Clear Filters
      </button>
    </div>

    <!-- Requests Table -->
    <div *ngIf="filteredRequests.length > 0" class="bg-white rounded-lg shadow-lg border border-gray-200 overflow-hidden">
      <div class="hidden md:block overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-[#679436]">
            <tr class="uppercase tracking-wider text-white text-xs lg:text-sm">
              <th class="px-4 py-3 text-center font-semibold w-12">
                <input 
                  type="checkbox" 
                  [checked]="selectAll"
                  (change)="toggleSelectAll()"
                  class="w-5 h-5 rounded border-2 border-white/50 bg-white/20 text-[#679436] focus:ring-2 focus:ring-white cursor-pointer">
              </th>
              <th class="px-6 py-3 text-left font-semibold">Student</th>
              <th class="px-6 py-3 text-left font-semibold">Event</th>
              <th class="px-6 py-3 text-center font-semibold">Requested</th>
              <th class="px-6 py-3 text-center font-semibold">Status / Actions</th>
            </tr>
          </thead>
          <tbody class="bg-white text-gray-800 divide-y divide-gray-200">
            <tr *ngFor="let request of pagedRequests; let i = index" 
                [class.bg-blue-50]="isSelected(request.id)"
                class="hover:bg-gray-50 transition-all duration-200">
              <!-- Checkbox -->
              <td class="px-4 py-4 text-center">
                <input 
                  type="checkbox" 
                  [checked]="isSelected(request.id)"
                  (change)="toggleSelectRequest(request.id)"
                  class="w-5 h-5 rounded border-2 border-gray-300 text-[#679436] focus:ring-2 focus:ring-[#679436] cursor-pointer">
              </td>
              
              <!-- Student Info -->
              <td class="px-6 py-4">
                <div class="flex items-start gap-3">
                  <div class="w-10 h-10 rounded-full bg-[#679436] flex items-center justify-center flex-shrink-0 text-white font-bold">
                    {{ request.first_name.charAt(0) }}{{ request.last_name.charAt(0) }}
                  </div>
                  <div class="flex flex-col">
                    <span class="text-sm font-bold text-[#679436]">{{ getStudentName(request) }}</span>
                    <span class="text-xs text-gray-600 flex items-center gap-1">
                      <i class="fas fa-id-card text-gray-400"></i>
                      {{ request.student_id }}
                    </span>
                    <span class="text-xs text-gray-600 flex items-center gap-1">
                      <i class="fas fa-envelope text-gray-400"></i>
                      {{ request.student_email }}
                    </span>
                    <span *ngIf="request.department" class="text-xs text-gray-600 flex items-center gap-1">
                      <i class="fas fa-graduation-cap text-gray-400"></i>
                      {{ request.department }}
                    </span>
                  </div>
                </div>
              </td>

              <!-- Event Info -->
              <td class="px-6 py-4">
                <div class="flex flex-col">
                  <span class="text-sm font-semibold text-gray-900">{{ request.event_title }}</span>
                  <span *ngIf="request.event_location" class="text-xs text-gray-600 flex items-center gap-1 mt-1">
                    <i class="fas fa-map-marker-alt text-gray-400"></i>
                    {{ request.event_location }}
                  </span>
                </div>
              </td>

              <!-- Requested Date -->
              <td class="px-6 py-4 text-center">
                <div class="flex flex-col items-center">
                  <span class="text-sm font-medium text-gray-900">{{ formatDate(request.requested_at_local || request.requested_at) }}</span>
                </div>
              </td>

              <!-- Status / Actions -->
              <td class="px-6 py-4">
                <div class="flex flex-col items-center gap-2">
                  <div class="flex items-center justify-center gap-2 w-full">
                    <select
                      [ngModel]="request.status"
                      (change)="updateRequestStatus(request, $any($event.target).value)"
                      [disabled]="updatingRequestId === request.id"
                      [ngClass]="getStatusSelectClass(request.status)"
                      class="w-full max-w-[160px] px-4 py-2.5 rounded-lg text-xs font-bold border-2 cursor-pointer focus:outline-none focus:ring-2 disabled:opacity-50 disabled:cursor-not-allowed transition-all uppercase tracking-wide">
                      <option value="pending">PENDING</option>
                      <option value="processing">PROCESSING</option>
                      <option value="sent">SENT</option>
                    </select>
                    <i *ngIf="updatingRequestId === request.id" class="fas fa-spinner fa-spin text-[#679436]"></i>
                    <!-- View certificate if available -->
                    <a *ngIf="request.certificate_url" [href]="request.certificate_url" target="_blank" rel="noopener" class="ml-2 px-3 py-1 bg-[#679436] text-white rounded text-xs font-semibold hover:bg-[#56732d] transition-all">View</a>
                  </div>
                  <div *ngIf="request.status === 'rejected' && request.rejection_reason" class="w-full">
                    <div class="bg-red-50 border border-red-200 rounded px-2 py-1">
                      <p class="text-xs text-red-700 font-medium">{{ request.rejection_reason }}</p>
                    </div>
                  </div>
                  <div *ngIf="request.processed_at" class="w-full text-center">
                    <p class="text-xs text-gray-500">Updated: {{ formatDate(request.processed_at_local || request.processed_at) }}</p>
                  </div>
                </div>
              </td>
            </tr>
          </tbody>
          </table>
      </div>

      <!-- Mobile Card View -->
      <div class="md:hidden space-y-4 p-4 bg-gray-50">
        <div *ngFor="let request of pagedRequests; let i = index" 
             class="bg-white rounded-lg shadow-md border border-gray-200 overflow-hidden"
             [class.ring-2]="isSelected(request.id)"
             [class.ring-[#679436]]="isSelected(request.id)">
          
          <!-- Header with Checkbox and Status -->
          <div class="bg-[#679436] px-4 py-3 flex justify-between items-center">
             <div class="flex items-center gap-3">
                <input 
                  type="checkbox" 
                  [checked]="isSelected(request.id)"
                  (change)="toggleSelectRequest(request.id)"
                  class="w-5 h-5 rounded border-2 border-white/50 bg-white/20 text-[#679436] focus:ring-2 focus:ring-white cursor-pointer">
                <span class="text-white font-bold truncate max-w-[150px]">{{ getStudentName(request) }}</span>
             </div>
             <span class="text-xs bg-white/20 text-white px-2 py-1 rounded">{{ request.student_id }}</span>
          </div>

          <!-- Body -->
          <div class="p-4 space-y-3">
             <!-- Event -->
             <div>
                <p class="text-xs text-gray-500 font-semibold uppercase">Event</p>
                <p class="font-medium text-gray-900">{{ request.event_title }}</p>
                <p *ngIf="request.event_location" class="text-xs text-gray-500 flex items-center gap-1 mt-0.5">
                   <i class="fas fa-map-marker-alt"></i> {{ request.event_location }}
                </p>
             </div>

             <!-- Requested Date -->
           <div>
             <p class="text-xs text-gray-500 font-semibold uppercase">Requested</p>
             <p class="font-medium text-gray-900">{{ formatDate(request.requested_at_local || request.requested_at) }}</p>
           </div>

             <!-- Status Action -->
             <div>
                <p class="text-xs text-gray-500 font-semibold uppercase mb-1">Status</p>
                <div class="flex items-center gap-2">
                    <select
                      [ngModel]="request.status"
                      (change)="updateRequestStatus(request, $any($event.target).value)"
                      [disabled]="updatingRequestId === request.id"
                      [ngClass]="getStatusSelectClass(request.status)"
                      class="w-full px-4 py-2.5 rounded-lg text-xs font-bold border-2 cursor-pointer focus:outline-none focus:ring-2 disabled:opacity-50 disabled:cursor-not-allowed transition-all uppercase tracking-wide">
                      <option value="pending">PENDING</option>
                      <option value="processing">PROCESSING</option>
                      <option value="sent">SENT</option>
                    </select>
                    <i *ngIf="updatingRequestId === request.id" class="fas fa-spinner fa-spin text-[#679436]"></i>
                    <a *ngIf="request.certificate_url" [href]="request.certificate_url" target="_blank" rel="noopener" class="ml-2 px-3 py-1 bg-[#679436] text-white rounded text-xs font-semibold hover:bg-[#56732d] transition-all">View</a>
                </div>
                <div *ngIf="request.status === 'rejected' && request.rejection_reason" class="w-full">
                    <div class="bg-red-50 border border-red-200 rounded px-2 py-1">
                      <p class="text-xs text-red-700 font-medium">{{ request.rejection_reason }}</p>
                    </div>
                  </div>
                <div *ngIf="request.processed_at" class="mt-1">
                  <p class="text-xs text-gray-500">Updated: {{ formatDate(request.processed_at_local || request.processed_at) }}</p>
                </div>
             </div>
          </div>
        </div>
      </div>
      
      <!-- Pagination and Results Summary -->
      <div class="px-6 py-4 bg-gray-50 border-t border-gray-200 flex flex-col sm:flex-row items-center justify-between gap-3">
        <p class="text-sm text-gray-600">
          Showing <span class="font-semibold text-gray-900">{{ (currentPage - 1) * itemsPerPage + 1 }}</span> 
          to <span class="font-semibold text-gray-900">{{ Math.min(currentPage * itemsPerPage, filteredRequests.length) }}</span> 
          of <span class="font-semibold text-gray-900">{{ filteredRequests.length }}</span> 
          {{ filteredRequests.length === 1 ? 'request' : 'requests' }}
          <span *ngIf="statusFilter !== 'all'"> with status: <span class="font-semibold">{{ statusFilter }}</span></span>
        </p>
        
        <!-- Pagination Controls -->
        <div *ngIf="totalPages > 1" class="flex items-center gap-2">
          <!-- Previous Button -->
          <button
            (click)="onPageChange(currentPage - 1)"
            [disabled]="currentPage === 1"
            class="px-3 py-1.5 rounded-lg border-2 border-gray-300 bg-white text-sm font-semibold text-gray-700 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-all">
            <i class="fas fa-chevron-left"></i>
          </button>
          
          <!-- Page Numbers -->
          <button
            *ngFor="let page of getPageNumbers()"
            (click)="page !== -1 && onPageChange(page)"
            [disabled]="page === -1"
            [class.bg-[#679436]]="page === currentPage"
            [class.text-white]="page === currentPage"
            [class.border-[#679436]]="page === currentPage"
            class="min-w-[2.5rem] px-3 py-1.5 rounded-lg border-2 border-gray-300 bg-white text-sm font-semibold text-gray-700 hover:bg-gray-50 disabled:cursor-default disabled:hover:bg-white transition-all">
            <span *ngIf="page !== -1">{{ page }}</span>
            <span *ngIf="page === -1">...</span>
          </button>
          
          <!-- Next Button -->
          <button
            (click)="onPageChange(currentPage + 1)"
            [disabled]="currentPage === totalPages"
            class="px-3 py-1.5 rounded-lg border-2 border-gray-300 bg-white text-sm font-semibold text-gray-700 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-all">
            <i class="fas fa-chevron-right"></i>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>


